package elsevier;
import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.Element;
import org.dom4j.Node;
import org.dom4j.XPath;
import org.dom4j.io.SAXReader;

public class Xml_parser {
	static ArrayList<ArrayList<String>>   all_references=new ArrayList<>();
	public static void main(String[] args) {
	      try {
	         File inputFile = new File("/mnt/Titas/Elsevier/41222.txt");
	         SAXReader reader = new SAXReader();
	         Document document = reader.read( inputFile );
	         
	         System.out.println("Root element :" 
	            + document.getRootElement().getName());
	         Element root = document.getRootElement();

	         // iterate through child elements of root
	   //       Map uris = new HashMap();
			 // uris.put("pqr", "http://www.tei-c.org/ns/1.0");
			 // XPath xpath = document.createXPath("/pqr:TEI/pqr:teiHeader");
			 // xpath.setNamespaceURIs(uris);
			 // List<Node> nodes = xpath.selectNodes(document);
	   //       Element classElement = document.getRootElement();
	         
	         System.out.println("The abstract wordcount = "+ get_Abstract_WC(document)+" words");
	         double n = (get_Abstract_WC(document)*1.0)/get_Rel_length(document);
	         System.out.println("The relative length is = "+ n);
	         System.out.println("Check_Template = "+check_template(document));
//	        List<Node> nodes = document.selectNodes("TEI/teiHeader/profileDesc/abstract" );
//	         System.out.println(nodes.size());
//	         System.out.println("----------------------------");
//	         for (Node node : nodes) 
//	         {
//	            System.out.println("\nCurrent Element :" 
//	               + node.getName());
//	            //System.out.println("Student roll no : " 
//	             //  + node.valueOf("@rollno") );
//	            System.out.println("Data : " + node.selectSingleNode("p").getText());
//	            String l = node.selectSingleNode("p").getText();
//	            System.out.println(getNum(l));
//	         } 
//	          //  System.out.println("Last Name : " + node.selectSingleNode("lastname").getText());
//	           // System.out.println("First Name : " + node.selectSingleNode("nickname").getText());
//	           // System.out.println("Marks : " + node.selectSingleNode("marks").getText());
//	            nodes = document.selectNodes("TEI/text/body/div");
//	            System.out.println(nodes.size());
//	            for (int i=0; i<nodes.size(); i++) 
//	            {
//	            	System.out.println(nodes.get(i).selectSingleNode("head").getText());
//	            	List<Node> nodes_1 = nodes.get(i).selectNodes("p");
//	            	for (int j=0; j<nodes_1.size(); j++)
//	            	{
//	            		String q = nodes_1.get(j).getText();
//		            //	System.out.println(q);
//		            	System.out.println(getNum(q));
//	            	}	
//	            }
	         
	      } catch (DocumentException e) {
	         e.printStackTrace();
	      }
	   }
	public static int getNum(String text)
	{
		String trimmed = text.trim();
		int words = trimmed.isEmpty() ? 0 : trimmed.split("\\s+").length;
		return words;
	}
	public static int get_Abstract_WC(Document document)
	{
		 List<Node> nodes = document.selectNodes("TEI/teiHeader/profileDesc/abstract" );
		 String l="";
		 for (Node node : nodes) 
         {
            System.out.println("Data : " + node.selectSingleNode("p").getText());
            l = node.selectSingleNode("p").getText();
         }
		 return getNum(l);
	}
	public static int get_Rel_length(Document document)
	{
		List<Node> nodes = document.selectNodes("TEI/text/body/div");
        System.out.println(nodes.size());
        int x=0;
        for (int i=0; i<nodes.size(); i++) 
        {
        	//System.out.println(nodes.get(i).selectSingleNode("head").getText());
        	List<Node> nodes_1 = nodes.get(i).selectNodes("p");
        	for (int j=0; j<nodes_1.size(); j++)
        	{
        		String q = nodes_1.get(j).getText();
            //	System.out.println(q);
            	x += getNum(q);
        	}	
        }
        return x;
	}
	public static boolean check_template(Document document)
	{
		String[] s = {"introduction","results","conclusions"};
		int k=0;
		ArrayList<Double> ind = new ArrayList<>();
		List<Node> nodes = document.selectNodes("TEI/teiHeader/profileDesc/abstract");
		if(nodes.isEmpty())
		{
			return false;
		}
		for(int i=0;i<3;i++)
		{
			nodes = document.selectNodes("TEI/text/body/div");
			for(int j=0;j<nodes.size();j++)
			{
				String l = nodes.get(j).selectSingleNode("head").getText();
				boolean contains = l.toLowerCase().trim().matches(".*\\b"+s[i]+"\\b.*");
				if(contains)
				{
					System.out.println(l);
					String arr[] = l.trim().split(" ", 2);
					String firstWord = arr[0];
					ind.add(Double.parseDouble(firstWord));
				}
			}
		}
		if(ind.size() < 3)
		{
			return false;
		}
		nodes = document.selectNodes("/TEI/text/back/div[@type='references']" );
		if(nodes.isEmpty())
		{
			return false;
		}
		boolean sorted = true;

		for (int i = 0; i < ind.size() - 1; i++) {
		    if (ind.get(i) > ind.get(i+1)) {
		        sorted = false;
		        break;
		    }
		}
		return sorted;
	}
	
//	public static int get_binary(double value, double threshold, String comp)
//	{
//		if(comp.equals(">="))
//		{
//			if(value >= threshold)
//			{
//				return 1;
//			}
//			else
//			{
//				return 0;
//			}
//		}
//		else if(comp.equals("<="))
//		{
//			if(value <= threshold)
//			{
//				return 0;
//			}
//			else
//			{
//				return 1;
//			}
//		}
//	}
	
	public static int number_of_self_citations(Document doc)
    {
        List<Node> nodes = doc.selectNodes("/TEI/teiHeader/fileDesc/sourceDesc/biblStruct/analytic/author" );
        String authors_name[]=new String[nodes.size()];
        int k=0;
        for (Node node : nodes)
        {
            if(node.selectSingleNode("persName/forename[@type='first']")!=null)
            {
                authors_name[k]=node.selectSingleNode("persName/forename[@type='first']").getText()+" ";
            
            }
            if(node.selectSingleNode("persName/forename[@type='middle']")!=null)
            {
                authors_name[k]+=node.selectSingleNode("persName/forename[@type='middle']").getText()+" ";
           
            }
            if(node.selectSingleNode("persName/surname")!=null)
            {
                authors_name[k]+=node.selectSingleNode("persName/surname").getText();
            }
            k++;
        }
        int number_of_self_citations=0;
        int flag=1;
        System.out.println("The self cited authors");
        for(int i=0;i<all_references.size();++i)
        {
            for(int j=0;j<nodes.size();++j)
            {
                if(flag==1)
                {
                        for(int l=0;l<all_references.get(i).size();++l)
                     {
                             if(authors_name[j].equals(all_references.get(i).get(l)))
                         {
                             ++number_of_self_citations;
                             System.out.println(authors_name[j]);
                             flag=0;
                              break;

                         }
                             else 
                             {
                                 boolean a=false;
                                 int last_index1=authors_name[j].length()-1;
                                 int last_index2=all_references.get(i).get(l).length()-1;
                                 if(authors_name[j].charAt(0)==all_references.get(i).get(l).charAt(0))
                                    a=true;
                                 while(authors_name[j].charAt(last_index1)!=' ')
                                 {
                                     if(authors_name[j].charAt(last_index1)==all_references.get(i).get(l).charAt(last_index2))
                                     {
                                         --last_index1;
                                         --last_index2;
                                     }
                                     else
                                     {
                                         a=false;
                                         break;
                                     }
                                 }
                                
                               if(a)
                               {
                                 ++number_of_self_citations;
                                System.out.println(authors_name[j]);
                                flag=0;
                                break;
                               }
                             }
                     } 
                }
               else
                {
                    flag=1;
                    break;
                }
                
                
            }
        }
        
        return  number_of_self_citations ;
            
    }
	public static void total_references(Document document)
    {
         List<Node> nodes = document.selectNodes("/TEI/text/back/div[@type='references']/listBibl/biblStruct" );
         System.out.println(nodes.size());
         String code[] = new String[nodes.size()];
         int count = 0;
         for (Node node : nodes) {
            System.out.println("---------------------------- Reference " + (count+1) + " ----------------------");
            code[count] = "b"+Integer.toString(count);
            System.out.println(code[count]);
            if(node.selectSingleNode("analytic/title")!=null)
                System.out.println("Title : " + node.selectSingleNode("analytic/title").getText());
            else
                System.out.println("Title : " + node.selectSingleNode("monogr/title").getText());
              List<Node> authors = node.selectNodes("analytic/author");
              System.out.println("Authors:");
              String name;
              ArrayList<String> temp=new ArrayList<String>();
              for(Node auth : authors)
              {
                  name = "";
                  if(auth.selectSingleNode("persName/forename[@type='first']")!=null)
                      name = name + auth.selectSingleNode("persName/forename[@type='first']").getText() + " ";
                 if(auth.selectSingleNode("persName/forename[@type='middle']")!=null)
                    name = name + auth.selectSingleNode("persName/forename[@type='middle']").getText() + " ";
                  if(auth.selectSingleNode("persName/surname")!=null)
                      name = name + auth.selectSingleNode("persName/surname").getText();
           
                  System.out.println(name);
                  temp.add(name);
                 
                 
              }
              all_references.add(temp);
              count++;
         }
         
    }
}
